<!DOCTYPE html>
<html lang="ru">
<head>
    <title>{{ instrument.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <a href="/" class="btn btn-outline-secondary mb-3">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>

    <div class="row">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h1 class="card-title">{{ instrument.name }}</h1>
                    <h4 class="text-muted">{{ instrument.brand.name }} / {{ instrument.category.name }}</h4>
                    <hr>
                    <p class="fs-5">{{ instrument.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç." }}</p>
                    <p>üìç <b>–ì–¥–µ –∑–∞–±—Ä–∞—Ç—å:</b> {{ instrument.location.name }} ({{ instrument.location.address }})</p>
                    <h3 class="text-primary mt-4">{{ instrument.price_per_day }} ‚ÇΩ / —Å—É—Ç–∫–∏</h3>
                    
                    {% if instrument.status == 'available' %}
                        <button onclick="book({{ instrument.id }})" class="btn btn-lg btn-success mt-3">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
                    {% else %}
                        <button disabled class="btn btn-lg btn-secondary mt-3">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>
                    {% endif %}
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –û—Ç–∑—ã–≤–æ–≤ -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0">–û—Ç–∑—ã–≤—ã ({{ reviews.count }})</h4>
                </div>
                <div class="card-body">
                    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
                    {% for review in reviews %}
                        <div class="mb-3 border-bottom pb-2">
                            <strong>{{ review.user.username }}</strong> 
                            <span class="text-warning">‚òÖ {{ review.rating }}</span>
                            <span class="text-muted small ms-2">{{ review.created_at|date:"d.m.Y" }}</span>
                            <p class="mt-1 mb-0">{{ review.comment }}</p>
                        </div>
                    {% empty %}
                        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                    {% endfor %}

                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    {% if user.is_authenticated %}
                        <h5 class="mt-4">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h5>
                        <form method="post">
                            {% csrf_token %}
                            <div class="mb-2">
                                {{ form.rating.label_tag }}
                                {{ form.rating }}
                            </div>
                            <div class="mb-2">
                                {{ form.comment.label_tag }}
                                {{ form.comment }}
                            </div>
                            <button type="submit" class="btn btn-primary mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>
                    {% else %}
                        <p class="mt-3"><a href="/login/">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –ö–æ–ø–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –∏ —Ç—É—Ç
    async function book(id) {
        const formData = new FormData();
        formData.append('id', id);
        const csrf = document.cookie.match(/csrftoken=([\w-]+)/)?.[1];
        try {
            let response = await fetch('/api/book/', {
                method: 'POST', body: formData, headers: {'X-CSRFToken': csrf}
            });
            let result = await response.json();
            alert(result.message);
            if (response.ok) location.reload();
        } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MuzRent Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a href="/" class="navbar-brand">üé∏ MuzRent Pro</a>
        <div class="d-flex">
            {% if user.is_authenticated %}
                <span class="text-light me-3 align-self-center">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</span>
                <a href="/profile/" class="btn btn-sm btn-outline-light me-2">–ö–∞–±–∏–Ω–µ—Ç</a>
                <form action="/logout/" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">–í—ã—Ö–æ–¥</button>
                </form>
            {% else %}
                <a href="/login/" class="btn btn-sm btn-light me-2">–í–æ–π—Ç–∏</a>
                <a href="/register/" class="btn btn-sm btn-outline-light">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4 p-3 shadow-sm">
        <form class="row g-3">
            <div class="col-md-4">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="category" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:"i" %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label>–ë—Ä–µ–Ω–¥</label>
                <select name="brand" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                    {% for b in brands %}
                    <option value="{{ b.id }}" {% if request.GET.brand == b.id|stringformat:"i" %}selected{% endif %}>
                        {{ b.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <a href="/" class="btn btn-secondary w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>

    <!-- –¢–æ–≤–∞—Ä—ã -->
    <div class="row" id="catalog-container">
        {% for item in instruments %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between">
                    <small class="text-muted">{{ item.category.name }}</small>
                    <small class="fw-bold">{{ item.brand.name }}</small>
                </div>
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{% url 'instrument_detail' item.id %}" class="text-decoration-none text-dark">
                            {{ item.name }}
                        </a>
                    </h5>
                    <p class="text-muted small">üìç {{ item.location.name }}</p>
                    <h3 class="text-primary">{{ item.price_per_day }} ‚ÇΩ <small class="fs-6">/—Å—É—Ç–∫–∏</small></h3>
                    
                    <!-- –ë–õ–û–ö –ö–ù–û–ü–ö–ò –° –£–ù–ò–ö–ê–õ–¨–ù–´–ú ID -->
                    <div id="btn-wrapper-{{ item.id }}">
                        {% if item.status == 'available' %}
                            <button onclick="book({{ item.id }})" 
                                    class="btn btn-primary w-100 booking-btn" 
                                    data-id="{{ item.id }}">
                                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        {% else %}
                            <button disabled class="btn btn-secondary w-100 booking-btn" data-id="{{ item.id }}">
                                {% if item.status == 'rented' %}–°–µ–π—á–∞—Å –≤ –∞—Ä–µ–Ω–¥–µ{% else %}–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ{% endif %}
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üîç</h3>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // 1. –§—É–Ω–∫—Ü–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    async function book(id) {
        const formData = new FormData();
        formData.append('id', id);
        const csrf = document.cookie.match(/csrftoken=([\w-]+)/)?.[1];

        try {
            let response = await fetch('/api/book/', {
                method: 'POST', body: formData, headers: {'X-CSRFToken': csrf}
            });
            let result = await response.json();
            alert(result.message);
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
            checkStatuses(); 
        } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
    async function checkStatuses() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ ID —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const buttons = document.querySelectorAll('.booking-btn');
        if (buttons.length === 0) return;

        const ids = Array.from(buttons).map(btn => btn.dataset.id).join(',');

        try {
            // –°–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(`/api/status/?ids=${ids}`);
            const data = await response.json();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            buttons.forEach(btn => {
                const id = btn.dataset.id;
                const newStatus = data[id]; // 'available', 'rented', 'maintenance'

                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏—à–µ–ª –∏ –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                // (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É, –Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                
                const wrapper = document.getElementById(`btn-wrapper-${id}`);
                
                if (newStatus === 'available') {
                    // –ï—Å–ª–∏ —Å—Ç–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ -> –¥–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π
                    if (btn.disabled) {
                        wrapper.innerHTML = `<button onclick="book(${id})" class="btn btn-primary w-100 booking-btn" data-id="${id}">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    }
                } else {
                    // –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–∞ -> –±–ª–æ–∫–∏—Ä—É–µ–º
                    if (!btn.disabled) {
                        const text = newStatus === 'rented' ? '–°–µ–π—á–∞—Å –≤ –∞—Ä–µ–Ω–¥–µ' : '–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ';
                        wrapper.innerHTML = `<button disabled class="btn btn-secondary w-100 booking-btn" data-id="${id}">${text}</button>`;
                    }
                }
            });
        } catch (e) {
            console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤:', e);
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(checkStatuses, 3000);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MuzRent Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ -->
<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <a href="/" class="navbar-brand mb-0 h1">üé∏ MuzRent Pro</a>
        <div>
            {% if user.is_authenticated %}
                <span class="text-light me-3">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</span>
                {% if user.is_superuser %}
                    <a href="/admin/" class="btn btn-outline-light btn-sm">–ê–¥–º–∏–Ω–∫–∞</a>
                {% endif %}
            {% else %}
                <a href="/admin/" class="btn btn-outline-light btn-sm">–í–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
        <div>
            <span class="fw-bold me-2">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</span>
            <a href="/" class="btn btn-sm btn-outline-primary me-1">–í—Å–µ</a>
            {% for cat in categories %}
                <a href="/?category={{ cat }}" class="btn btn-sm btn-outline-secondary me-1">{{ cat }}</a>
            {% endfor %}
        </div>
        
        {% if user.is_authenticated %}
            <a href="/profile/" class="btn btn-success btn-sm">üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% endif %}
    </div>

    <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class="row" id="catalog">
        {% for item in instruments %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">{{ item.name }}</h5>
                        <span class="badge bg-light text-dark border">{{ item.category }}</span>
                    </div>
                    
                    <h3 class="text-primary my-3">{{ item.price }} ‚ÇΩ <small class="fs-6 text-muted">/ —Å—É—Ç–∫–∏</small></h3>
                    
                    {% if item.status == 'available' %}
                        <div class="d-grid">
                            <button onclick="book({{ item.id }})" class="btn btn-primary">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                        <div class="text-center mt-2">
                            <span class="badge bg-success-subtle text-success rounded-pill">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏</span>
                        </div>
                    {% else %}
                        <div class="d-grid">
                            <button disabled class="btn btn-secondary">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>
                        </div>
                        <div class="text-center mt-2">
                            <span class="badge bg-danger-subtle text-danger rounded-pill">üö´ –°–µ–π—á–∞—Å –≤ –∞—Ä–µ–Ω–¥–µ</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
            <div class="col-12 text-center py-5">
                <h3 class="text-muted">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ üòî</h3>
                <a href="/" class="btn btn-outline-primary mt-3">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º</a>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    async function book(id) {
        const formData = new FormData();
        formData.append('id', id);
        const csrf = document.cookie.match(/csrftoken=([\w-]+)/)?.[1];

        try {
            let response = await fetch('/api/book/', {
                method: 'POST', 
                body: formData,
                headers: {'X-CSRFToken': csrf}
            });
            let result = await response.json();
            
            if (response.ok) {
                alert(result.message);
                location.reload();
            } else {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (403/409), —Ç–æ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                alert(result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏");
            }
        } catch(e) { 
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞'); 
        }
    }
</script>

</body>
</html>
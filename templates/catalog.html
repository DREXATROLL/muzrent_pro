<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MuzRent Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a href="/" class="navbar-brand">üé∏ MuzRent Pro</a>
        <div class="d-flex">
            {% if user.is_authenticated %}
                <span class="text-light me-3 align-self-center">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</span>
                <a href="/profile/" class="btn btn-sm btn-outline-light me-2">–ö–∞–±–∏–Ω–µ—Ç</a>
                <form action="/logout/" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">–í—ã—Ö–æ–¥</button>
                </form>
            {% else %}
                <a href="/login/" class="btn btn-sm btn-light me-2">–í–æ–π—Ç–∏</a>
                <a href="/register/" class="btn btn-sm btn-outline-light">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4 p-3 shadow-sm">
        <form class="row g-3">
            <div class="col-md-4">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="category" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:"i" %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label>–ë—Ä–µ–Ω–¥</label>
                <select name="brand" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                    {% for b in brands %}
                    <option value="{{ b.id }}" {% if request.GET.brand == b.id|stringformat:"i" %}selected{% endif %}>
                        {{ b.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <a href="/" class="btn btn-secondary w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>

    <!-- –¢–æ–≤–∞—Ä—ã -->
    <div class="row">
        {% for item in instruments %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between">
                    <small class="text-muted">{{ item.category.name }}</small>
                    <small class="fw-bold">{{ item.brand.name }}</small>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ item.name }}</h5>
                    <p class="text-muted small">üìç {{ item.location.name }}</p>
                    <h3 class="text-primary">{{ item.price_per_day }} ‚ÇΩ <small class="fs-6">/—Å—É—Ç–∫–∏</small></h3>
                    
                    {% if item.status == 'available' %}
                        <button onclick="book({{ item.id }})" class="btn btn-primary w-100">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    {% else %}
                        <button disabled class="btn btn-secondary w-100">
                            {% if item.status == 'rented' %}–°–µ–π—á–∞—Å –≤ –∞—Ä–µ–Ω–¥–µ
                            {% else %}–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ{% endif %}
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üîç</h3>
        </div>
        {% endfor %}
    </div>
    
    <div class="text-center mt-5 text-muted small">
        <a href="/api/v1/instruments/" target="_blank">REST API Link</a> (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
    </div>
</div>

<script>
    async function book(id) {
        const formData = new FormData();
        formData.append('id', id);
        const csrf = document.cookie.match(/csrftoken=([\w-]+)/)?.[1];

        try {
            let response = await fetch('/api/book/', {
                method: 'POST', body: formData, headers: {'X-CSRFToken': csrf}
            });
            let result = await response.json();
            alert(result.message);
            if (response.ok) location.reload();
        } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }
</script>
</body>
</html>